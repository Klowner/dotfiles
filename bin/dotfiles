#!/bin/bash -e
# Installation:
# curl https://raw.github.com/Klowner/dotfiles/main/bin/dotfiles | bash
basedir="${DOTFILES_ROOT:-$HOME/.dotfiles}"
bindir="${DOTFILES_BIN:-$HOME/bin}"
repo="Klowner/dotfiles"
gitbase="git://github.com/${repo}.git"
gitbranch="${DOTFILES_BRANCH:-main}"
gitremote="git@github.com:${repo}"
tarball="http://github.com/${repo}/tarball/${gitbranch}"

function has() {
  return $(which $1 &> /dev/null)
}

function missing() {
  ! has $1
}

function stat() {
  GIT_DIR=${basedir}/.git git diff --stat
}

function note() {
  echo "[32;1m * [0m$*"
}

function warn() {
  echo "[31;1m * [0m$*"
}

function die() {
  warn $*
  exit 1
}

function destination() {
  path=$1
  path=${path/\_/.}
  path=${path//\_//}
  echo $path
}

function dirname() {
  path=$1
  path=${path%"${path##*[!/]}"}
  path=${path%/*}
  echo $path
}

function reverse_destination() {
  path=$1
  path=${path/\./_/}
  echo $path
  echo path $path
}

function link() {
  src=$1
  dst=$2
  if [ -e $dst ]; then
    if [ -L $dst ]; then
      # Symlink already exists
      return
    else
      # Rename existing files with ".old" extension
      warn "$dst already exists, renaming to $dst.old"
      backup=$dst.old
      if [ -e $backup ]; then
        die "$backup already exists. Aborting."
      fi
      mv -v $dst $backup
    fi
  fi
  # Update existing or create new symlink
  ln -vsf $src $dst
}

function install_via_tarball() {
  note "Downloading tarball..."
  mkdir -vp $basedir
  cd $basedir
  tempfile=TEMP.tar.gz
  if has curl; then
    curl -L $tarball >$tempfile
  elif has wget; then
    wget -O $tempfile $tarball
  else:
    die "Can't download tarball."
  fi
  tar --strip-components 1 -xzvf $tempfile
  rm -v $tempfile
}

function install_via_git() {
  note "Cloning dotfiles git repository..."
  git clone ${gitremote} ${basedir}
}


function bootstrap() {
  note "Bootstrapping..."
  if missing curl && missing wget; then
    die "missing: curl or wget"
  fi
  if missing git; then
    die "missing: git"
  fi

  if [ -e $basedir ]; then
    # Try to determine if these dotfiles already installed
    if [ -e "${basedir}/.git" ]; then
      local current_remote=$(GIT_DIR=${basedir}/.git git remote -v | grep origin\.\*\(fetch\) | awk '{print $2}')
      if [ $current_remote = $gitremote ]; then
        die "Dotfiles already installed!"
      fi
    fi
    warn "$basedir exists, moving to ${basedir}.bak"
    mv "${basedir}" "${basedir}.bak"
  fi
  install_via_tarball
}

function install() {
  note "Symlinking configuration files..."
  for path in _*; do
    dst=$(destination $path)
    dstdir=$(dirname $dst)
    echo "$path"
    case $path in
      .|..|.git)
        continue
        ;;
      *)
        link $basedir/$path $HOME/$dst
        ;;
    esac
  done

  note "Installing ~/bin script links... ${bindir}"
  mkdir -v -p ${bindir}
  if [ -d ${bindir} ]; then
    for path in ${basedir}/bin/*; do
      link $path ${bindir}/${path##*/}
    done
  fi
  note "Done"
}

function git_migrate() {
  if missing git; then
    return
  fi
  if [ ! -d "${basedir}/.git" ]; then
    note "Migrating dotfiles to git repository..."
    git clone $gitremote --no-checkout --branch ${gitbranch} "${basedir}/migrate"
    git mv "${basedir}/migrate/.git" "${basedir}/.git"
    rm -rf "${basedir}/migrate"
  fi
}

function add() {
  path=$1
  dst="${path/"$HOME"/}" # remove leading $HOME from path
  dst="${dst/\//}" # remove leading slash
  dst="${dst//[.|\/]/_}" # replace slashes with underscores

  note "Adding $path..."
  cp -avr $path $basedir/$dst
  mv $path $path.old
  link $basedir/$dst $path
}

function info() {
  echo "location:   ${basedir}"
  echo "commands:   ${bindir}"
  echo "git:        ${gitremote}:${gitbranch}"
}

# Hopefully detect if this script is being piped to bash
if [ "${0/*\//}" != "dotfiles" ]; then
  bootstrap && \
  install && \
  exit
fi

git_migrate

cmd=${1:-help}
case $cmd in
  install) install;;
  add)     add ${@:2};;
  info)    info;;
  status)  stat;;
  help)
    echo "Commands:"
    echo " - install      Install to $basedir"
    echo " - add <path>"
    echo " - info         Print script variables"
    echo " - status       Show changed items in .dotfiles"
    ;;
esac

# vim:ts=2:sw=2:et:
