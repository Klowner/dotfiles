#!/bin/bash
DEFAULT_USERNAME=mriedesel.cipa
MYSELF=$(whoami)
IP=$1
DIRPATH=$2

G='\e[0;32m'
R='\e[1;31m'
DEF='\e[0m'

if [[ -z $USERNAME ]]; then
	USERNAME=$DEFAULT_USERNAME
fi

if [[ -z $IP || -z $DIRPATH ]]; then
	echo "Use sshfs to mount target directory to IP's /usr/cipafilter/www"
	echo ""
	echo "To mount"
	echo -e "Usage: ${G}$0  <ip>  <localdir>  <relative remotedir>${DEF}"
	echo ""
	echo "To unmount a currently mounted directory: "
	echo -e "Usage: ${G}$0  <ip>  unmount  <relative remotedir>${DEF} "
	echo ""
	echo -e "${R}NOTICE:${DEF} Ensure you can ssh from the target to your local machine"

	exit 0;
fi

ABSDIRPATH=$(realpath $2)

if [[ -z $3 ]]; then
	DSTPATH=$(realpath --relative-to . $DIRPATH)
else
	DSTPATH=$3
fi

if [[ $2 == "unmount" ]]; then
	ssh $USERNAME@$IP sudo fusermount -u /usr/cipafilter/www/$DSTPATH && echo -e "${G}successfully unmounted $DSTPATH${DEF}"
	exit
fi

ssh -T $USERNAME@$IP 1> /dev/null <<EOF
	which sshfs || sudo apt-get install -y sshfs
	MYIP=\$(echo \$SSH_CLIENT | cut -d ' ' -f 1)
	DSTPATH=/usr/cipafilter/www/$DSTPATH

	# Unmount if mounted
	mountpoint -q \$DSTPATH && sudo fusermount -u \$DSTPATH

	# Move if existing and filled
	#[ "\$(ls \$DSTPATH)" ] && sudo mv \$DSTPATH \$DSTPATH.original

	if [[ ! -e \$DSTPATH ]]; then
		sudo mkdir -p \$DSTPATH
		sudo chown www-data:www-data \$DSTPATH
	fi

	sudo -E sshfs -o nonempty,allow_other,user=www-data $MYSELF@\$MYIP:$ABSDIRPATH \$DSTPATH
	exit
EOF

echo -e "${G}Possibly successfully mounted ${DEF}$ABSDIRPATH${G} to ${DEF}$DSTPATH on $IP"

